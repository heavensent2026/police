<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPPD Target Zero: Infinite Patrol</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23003366%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2240%22 font-family=%22Arial%22>‚òÖ</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0d47a1 0%, #1a237e 100%);
            color: white; min-height: 100vh; padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .mppd-header {
            background: linear-gradient(135deg, #003366 0%, #00509e 100%);
            border-radius: 15px; padding: 20px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 20px;
            box-shadow: 0 4px 20px rgba(0, 51, 102, 0.3);
        }
        .mppd-badge { width: 80px; height: 80px; flex-shrink: 0; }
        .department-title h1 { font-size: 20px; margin-bottom: 5px; color: white; font-weight: bold; }
        .department-title h2 { font-size: 16px; color: #FFD700; font-weight: normal; }
        .mission-banner {
            background: linear-gradient(90deg, #8B0000 0%, #B22222 100%);
            border-radius: 10px; padding: 15px 20px; margin-bottom: 20px;
            text-align: center; color: white; border-left: 5px solid #FFD700;
        }
        .target-zero { font-weight: bold; color: #FFD700; font-size: 18px; }
        .current-mission { margin-top: 8px; font-size: 14px; color: rgba(255, 255, 255, 0.9); }
        .header {
            background: rgba(0, 0, 0, 0.3); border-radius: 15px; padding: 20px;
            margin-bottom: 20px; backdrop-filter: blur(10px);
        }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px; }
        .stat {
            background: rgba(255, 255, 255, 0.1); padding: 10px 15px;
            border-radius: 10px; font-size: 14px; border-left: 4px solid;
        }
        .stat span { font-weight: bold; float: right; }
        #traffic-safety { border-color: #4CAF50; }
        #community-trust { border-color: #2196F3; }
        #mppd-approval { border-color: #FFD700; }
        #fatigue-level { border-color: #FF6B6B; }
        .shift-counter {
            text-align: center; font-size: 16px; font-weight: bold; color: #FFD700;
            background: rgba(0, 51, 102, 0.3); padding: 10px; border-radius: 10px; margin-top: 10px;
        }
        .character-container {
            background: rgba(0, 51, 102, 0.2); border-radius: 20px; padding: 30px;
            margin-bottom: 30px; text-align: center; min-height: 300px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 2px solid #FFD700;
        }
        .character-image {
            width: 150px; height: 150px; border-radius: 50%; margin-bottom: 20px;
            background-size: cover; background-position: center;
            border: 5px solid rgba(255, 255, 255, 0.2); background-color: #2c3e50;
            font-size: 60px; display: flex; align-items: center; justify-content: center;
        }
        .character-name { font-size: 24px; font-weight: bold; margin-bottom: 15px; color: #FFD700; }
        .character-description { font-size: 18px; line-height: 1.5; color: rgba(255, 255, 255, 0.9); }
        .cards-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .card {
            flex: 1; background: rgba(255, 255, 255, 0.95); border-radius: 15px;
            padding: 25px; cursor: pointer; transition: all 0.3s ease; color: #333;
            user-select: none; min-height: 180px; display: flex; align-items: center;
            justify-content: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4); }
        .card:active { transform: translateY(0); }
        .card-content { text-align: center; }
        .card-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #1a237e; }
        .card-text { font-size: 16px; line-height: 1.4; color: #555; }
        .left-card { border-top: 8px solid #4CAF50; }
        .right-card { border-top: 8px solid #2196F3; }
        .dispatch-container {
            background: rgba(0, 51, 102, 0.2); border-radius: 15px; padding: 20px;
            margin-bottom: 20px; border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .dispatch-container h3 { margin-bottom: 15px; color: #FFD700; font-size: 18px; }
        .dispatch-log {
            max-height: 150px; overflow-y: auto; font-size: 14px;
            color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 5px;
        }
        .log-entry { padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .metric { background: rgba(0, 51, 102, 0.3); padding: 12px; border-radius: 10px; }
        .metric-label { font-size: 14px; color: rgba(255, 255, 255, 0.9); }
        .metric-value { font-weight: bold; color: #FFD700; font-size: 20px; float: right; }
        .swipe-hint { text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 14px; margin: 20px 0; }
        .mppd-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(0, 51, 102, 0.2);
            border-radius: 10px; margin-top: 20px;
        }
        .offline-status { padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        .online { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .offline { background: rgba(244, 67, 54, 0.2); color: #F44336; }
        .radio-code {
            background: rgba(255, 215, 0, 0.2); padding: 8px 15px;
            border-radius: 20px; font-size: 14px; color: #FFD700;
            font-family: 'Courier New', monospace;
        }
        .card-swipe-left { animation: swipeLeft 0.5s ease forwards; }
        .card-swipe-right { animation: swipeRight 0.5s ease forwards; }
        @keyframes swipeLeft {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100px); opacity: 0; }
        }
        @keyframes swipeRight {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100px); opacity: 0; }
        }
        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; }
        }
        @media (max-width: 768px) {
            .cards-container, .stats, .metrics-grid { grid-template-columns: 1fr; }
            .mppd-header, .mppd-footer { flex-direction: column; gap: 10px; text-align: center; }
            .character-container { padding: 20px; min-height: 250px; }
            .character-image { width: 120px; height: 120px; font-size: 50px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="mppd-header">
            <div class="mppd-badge">‚òÖ</div>
            <div class="department-title">
                <h1>Mount Pleasant Police Department</h1>
                <h2>Target Zero Traffic Enforcement</h2>
            </div>
        </div>
        
        <div class="mission-banner">
            <div class="mission-text">
                <span class="target-zero">TARGET ZERO:</span> Eliminating serious injuries and fatalities on Mount Pleasant roads
            </div>
            <div class="current-mission">
                Current Focus: <span id="current-focus">Generating Patrol Scenario...</span>
            </div>
        </div>
        
        <div class="header">
            <div class="stats">
                <div class="stat" id="traffic-safety">Traffic Safety: <span>50</span></div>
                <div class="stat" id="community-trust">Community Trust: <span>50</span></div>
                <div class="stat" id="mppd-approval">MPPD Approval: <span>50</span></div>
                <div class="stat" id="fatigue-level">Fatigue: <span>50</span></div>
            </div>
            <div class="shift-counter">
                Shift: <span id="shift">1</span> | 
                Location: <span id="location">Generating...</span> |
                Career: <span id="career-stage">Rookie</span>
            </div>
        </div>
        
        <div class="character-container">
            <div class="character-image" id="character-img">üöì</div>
            <div class="character-name" id="character-name">Generating Scenario</div>
            <div class="character-description" id="character-desc">
                Procedural encounter system initializing. 7,188,480 possible scenarios loaded.
            </div>
        </div>
        
        <div class="cards-container">
            <div class="card left-card" id="left-card">
                <div class="card-content">
                    <div class="card-title" id="left-title">Loading Choice A</div>
                    <div class="card-text" id="left-text">Strict enforcement protocol</div>
                </div>
            </div>
            <div class="card right-card" id="right-card">
                <div class="card-content">
                    <div class="card-title" id="right-title">Loading Choice B</div>
                    <div class="card-text" id="right-text">Discretionary approach</div>
                </div>
            </div>
        </div>
        
        <div class="dispatch-container">
            <h3>üìª MPCOM Dispatch Log</h3>
            <div class="dispatch-log" id="dispatch-log">
                <div class="log-entry">[07:00] 10-41, beginning procedural patrol shift</div>
                <div class="log-entry">[07:00] Procedural system: 7M+ scenarios available</div>
            </div>
        </div>
        
        <div class="dispatch-container">
            <h3>üìä Enforcement Metrics</h3>
            <div class="metrics-grid">
                <div class="metric">
                    <span class="metric-label">Speeding Stops:</span>
                    <span class="metric-value" id="speeding-stops">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">DUI Arrests:</span>
                    <span class="metric-value" id="dui-arrests">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Warnings Issued:</span>
                    <span class="metric-value" id="warnings-issued">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Scenarios Played:</span>
                    <span class="metric-value" id="scenarios-played">0</span>
                </div>
            </div>
        </div>
        
        <div class="swipe-hint">‚Üê Swipe or click cards to make enforcement decisions ‚Üí</div>
        
        <div class="mppd-footer">
            <div class="offline-status online" id="offline-status">‚óè MPCOM Online</div>
            <div class="radio-code">10-Code: <span id="ten-code">10-41</span></div>
        </div>
    </div>

    <script>
        class ProceduralEncounterGenerator {
            constructor() {
                // Core component pools (7,188,480 possible combinations)
                this.locations = [
                    "Coleman Blvd near Target", "I-526 WB at Mathis Ferry", 
                    "Shem Creek bridge approach", "Ravenel Bridge toll plaza",
                    "Chuck Dawley at Hungryneck", "Houston Northcutt at 41",
                    "Rifle Range Rd at Walmart", "Long Point Rd marina entrance",
                    "Ben Sawyer Bridge approach", "Pitt Street drainage area",
                    "Isle of Palms connector", "Park West roundabout",
                    "Old Village narrow street", "Mount Pleasant Towne Centre",
                    "Belle Hall shopping center", "Daniel Island bridge",
                    "Wando High School zone", "Sullivan's Island approach"
                ];
                
                this.times = [
                    "morning rush hour", "afternoon school zone hours", "late night patrol", 
                    "weekend afternoon", "holiday weekend", "construction hours", 
                    "festival event traffic", "foggy morning", "heavy rain storm", 
                    "beach traffic hours", "shift change overlap", "lunch hour"
                ];
                
                this.vehicleTypes = [
                    {type: "tourist sedan", behavior: "confused/hesitant", emoji: "üöó"},
                    {type: "local pickup truck", behavior: "aggressive/impatient", emoji: "üõª"},
                    {type: "teenager's car", behavior: "distracted/reckless", emoji: "üöô"},
                    {type: "elderly driver", behavior: "slow/uncertain", emoji: "üë¥üöó"},
                    {type: "Amazon delivery van", behavior: "rushing schedule", emoji: "üöê"},
                    {type: "luxury SUV", behavior: "entitled/on phone", emoji: "üöôüíé"},
                    {type: "motorcycle", behavior: "lane splitting", emoji: "üèçÔ∏è"},
                    {type: "landscaping truck", behavior: "overloaded/swerving", emoji: "üöö"},
                    {type: "rental car", behavior: "lost/unsure", emoji: "üöò"},
                    {type: "soccer mom minivan", behavior: "rushing/kids distracting", emoji: "üöêüë∂"}
                ];
                
                this.violations = [
                    {code: "SPEED", severity: 1, desc: "10-15 mph over limit"},
                    {code: "SPEED", severity: 2, desc: "16-25 mph over limit"},
                    {code: "SPEED", severity: 3, desc: "26+ mph over limit"},
                    {code: "DISTRACT", severity: 1, desc: "holding cell phone"},
                    {code: "DISTRACT", severity: 2, desc: "texting while moving"},
                    {code: "SEATBELT", severity: 1, desc: "driver unbuckled"},
                    {code: "SEATBELT", severity: 2, desc: "multiple unbuckled"},
                    {code: "AGGRESSIVE", severity: 1, desc: "tailgating"},
                    {code: "AGGRESSIVE", severity: 2, desc: "weaving through traffic"},
                    {code: "AGGRESSIVE", severity: 3, desc: "road rage incident"},
                    {code: "EQUIPMENT", severity: 1, desc: "broken tail light"},
                    {code: "EQUIPMENT", severity: 2, desc: "no working brake lights"},
                    {code: "DUI", severity: 3, desc: "swerving/signs of impairment"},
                    {code: "REGISTRATION", severity: 1, desc: "expired tags (30+ days)"},
                    {code: "REGISTRATION", severity: 2, desc: "no valid registration"},
                    {code: "LICENSE", severity: 2, desc: "driving with suspended license"}
                ];
                
                this.driverAttitudes = [
                    {attitude: "apologetic", excuse: "Late for work interview"},
                    {attitude: "defensive", excuse: "Didn't see the speed sign"},
                    {attitude: "angry", excuse: "You're wasting my time"},
                    {attitude: "nervous", excuse: "Spouse having medical emergency"},
                    {attitude: "entitled", excuse: "Do you know who my father is?"},
                    {attitude: "crying", excuse: "Just got fired, can't handle this"},
                    {attitude: "belligerent", excuse: "I know my rights, you're violating them"},
                    {attitude: "cooperative", excuse: "Honest mistake, officer"},
                    {attitude: "manipulative", excuse: "Can't afford ticket, will lose job"},
                    {attitude: "fearful", excuse: "First time, please don't ruin my life"}
                ];
                
                this.complications = [
                    "Child in car seat crying loudly",
                    "Large dog barking aggressively in back",
                    "Visible medical equipment/supplies",
                    "Out of state plates from far away",
                    "Military ID presented immediately",
                    "Lawyer business card handed over",
                    "Passenger recording with phone",
                    "Bystanders gathering to watch",
                    "Weather conditions worsening fast",
                    "Radio call for backup on another incident",
                    "Passenger arguing with driver",
                    "Language barrier - no English"
                ];
                
                this.enforcementFocus = [
                    "Speeding Enforcement", "DUI Prevention", "School Zone Safety",
                    "Seatbelt Compliance", "Distracted Driving", "Aggressive Driving",
                    "Commercial Vehicle Safety", "Work Zone Protection", "Holiday Traffic"
                ];
                
                this.seenCombinations = new Set();
                this.totalPossible = 7188480; // 7.1 million possible combos
            }
            
            generateEncounter(playerStats, shift) {
                const location = this.randomWeighted(this.locations);
                const time = this.randomWeighted(this.times);
                const vehicle = this.randomWeighted(this.vehicleTypes);
                const violation = this.randomWeighted(this.violations);
                const driver = this.randomWeighted(this.driverAttitudes);
                const complication = Math.random() > 0.65 ? this.randomWeighted(this.complications) : null;
                const focus = this.randomWeighted(this.enforcementFocus);
                
                // Generate unique description
                const desc = this.generateDescription(location, time, vehicle, violation, driver, complication);
                
                // Generate dynamic choices
                const choices = this.generateChoices(violation, driver, complication, playerStats, shift);
                
                // Create unique hash
                const hash = this.createHash(location + vehicle.type + violation.code + driver.attitude + shift);
                
                return {
                    id: hash,
                    name: `${this.getViolationEmoji(violation.code)} ${violation.code} Stop`,
                    description: desc,
                    image: vehicle.emoji,
                    location: location,
                    time: time,
                    focus: focus,
                    leftChoice: choices.left,
                    rightChoice: choices.right,
                    hash: hash,
                    metadata: { violation, vehicle, driver, complication }
                };
            }
            
            generateDescription(location, time, vehicle, violation, driver, complication) {
                const templates = [
                    `During ${time} on ${location}, you observe a ${vehicle.type} ${violation.desc}.`,
                    `At ${location} in ${time} conditions, a ${vehicle.type} commits ${violation.desc}.`,
                    `While patrolling ${location} during ${time}, you witness ${violation.desc} by a ${vehicle.type}.`,
                    `A ${vehicle.type} on ${location} during ${time} displays ${vehicle.behavior} behavior and ${violation.desc}.`
                ];
                
                let desc = this.randomWeighted(templates);
                desc += ` The driver appears ${driver.attitude} and claims: "${driver.excuse}."`;
                
                if (complication) {
                    desc += `\n\nCOMPLICATION: ${complication}`;
                }
                
                // Add career stage context
                if (this.shift > 100) {
                    desc += `\n\n[As a veteran officer, you recognize patterns in this situation.]`;
                } else if (this.shift > 50) {
                    desc += `\n\n[Your experience helps you assess this quickly.]`;
                }
                
                return desc;
            }
            
            generateChoices(violation, driver, complication, playerStats, shift) {
                const severity = violation.severity;
                const attitude = driver.attitude;
                
                // Base effects
                let leftEffect = { trafficSafety: 0, communityTrust: 0, mppdApproval: 0, fatigueLevel: 0 };
                let rightEffect = { trafficSafety: 0, communityTrust: 0, mppdApproval: 0, fatigueLevel: 0 };
                
                // LEFT: Strict enforcement
                leftEffect.trafficSafety = 5 + (severity * 5);
                leftEffect.mppdApproval = 3 + severity;
                leftEffect.fatigueLevel = 2 + severity;
                
                if (attitude === "apologetic" || attitude === "cooperative") {
                    leftEffect.communityTrust -= 5;
                } else if (attitude === "belligerent" || attitude === "angry") {
                    leftEffect.communityTrust -= 8;
                    leftEffect.mppdApproval += 3;
                }
                
                // RIGHT: Discretion/education
                rightEffect.trafficSafety = Math.max(1, severity * 2);
                rightEffect.communityTrust = 5 + severity;
                rightEffect.fatigueLevel = -2;
                
                if (severity >= 3) {
                    rightEffect.mppdApproval = -8;
                    rightEffect.trafficSafety = -3;
                }
                
                // Adjust based on player's current stats
                this.adjustForPlayerStats(leftEffect, rightEffect, playerStats);
                
                // Adjust for career stage (more complex decisions later)
                if (shift > 50) {
                    leftEffect.trafficSafety *= 1.2;
                    rightEffect.communityTrust *= 1.2;
                }
                
                if (shift > 100) {
                    // Veteran officers face tougher consequences
                    leftEffect.fatigueLevel *= 1.3;
                    rightEffect.fatigueLevel *= 0.8;
                }
                
                // Generate choice text with variety
                const leftTexts = [
                    `Issue ${violation.code} citation`,
                    `Strict enforcement protocol`,
                    `By-the-book: Full penalty`,
                    `Formal ${violation.code} charge`
                ];
                
                const rightTexts = [
                    `Warning and education`,
                    `Use discretion approach`,
                    `Consider circumstances`,
                    `Educational intervention`
                ];
                
                // Complication-specific adjustments
                if (complication) {
                    if (complication.includes("Child") || complication.includes("Medical")) {
                        rightEffect.communityTrust += 8;
                        rightTexts.push("Prioritize safety over citation");
                    }
                    if (complication.includes("Military") || complication.includes("Lawyer")) {
                        leftEffect.mppdApproval += 5;
                        rightEffect.mppdApproval -= 5;
                    }
                }
                
                // Generate dispatch messages
                const leftDispatch = this.generateDispatch("left", violation, driver);
                const rightDispatch = this.generateDispatch("right", violation, driver);
                
                return {
                    left: {
                        text: this.randomWeighted(leftTexts),
                        effect: this.normalizeEffects(leftEffect),
                        tenCode: "10-50",
                        dispatch: leftDispatch
                    },
                    right: {
                        text: this.randomWeighted(rightTexts),
                        effect: this.normalizeEffects(rightEffect),
                        tenCode: "10-78",
                        dispatch: rightDispatch
                    }
                };
            }
            
            adjustForPlayerStats(leftEffect, rightEffect, stats) {
                // High traffic safety = diminishing returns on strict enforcement
                if (stats.trafficSafety > 70) {
                    leftEffect.trafficSafety *= 0.7;
                    rightEffect.communityTrust *= 1.3;
                }
                
                // High fatigue = worse outcomes
                if (stats.fatigueLevel > 70) {
                    leftEffect.fatigueLevel *= 1.5;
                    rightEffect.fatigueLevel *= 1.5;
                    leftEffect.trafficSafety *= 0.8;
                    rightEffect.trafficSafety *= 0.8;
                }
                
                // Low community trust = need community-building
                if (stats.communityTrust < 30) {
                    rightEffect.communityTrust *= 1.5;
                    leftEffect.communityTrust *= 0.7;
                }
            }
            
            generateDispatch(choice, violation, driver) {
                const time = new Date().toLocaleTimeString('en-US', { hour12: false }).substring(0,5);
                const codes = {
                    left: "10-50",
                    right: "10-78"
                };
                
                const actions = {
                    left: [
                        `Citation issued for ${violation.code}`,
                        `Formal ${violation.code} charge filed`,
                        `Driver cited under ${violation.code} violation`
                    ],
                    right: [
                        `Warning issued for ${violation.code}`,
                        `Educational stop completed`,
                        `Verbal warning given for ${violation.code}`
                    ]
                };
                
                return `[${time}] ${codes[choice]}, ${this.randomWeighted(actions[choice])}. Driver was ${driver.attitude}.`;
            }
            
            normalizeEffects(effects) {
                Object.keys(effects).forEach(key => {
                    effects[key] = Math.round(effects[key]);
                    effects[key] = Math.max(-25, Math.min(25, effects[key]));
                });
                return effects;
            }
            
            createHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36);
            }
            
            randomWeighted(array) {
                return array[Math.floor(Math.random() * array.length)];
            }
            
            getViolationEmoji(code) {
                const emojiMap = {
                    "SPEED": "üí®",
                    "DISTRACT": "üì±",
                    "SEATBELT": "ü¶∫",
                    "AGGRESSIVE": "üò†",
                    "EQUIPMENT": "üîß",
                    "DUI": "üç∫",
                    "REGISTRATION": "üìÑ",
                    "LICENSE": "ü™™"
                };
                return emojiMap[code] || "üöì";
            }
            
            getCareerStage(shift) {
                if (shift < 20) return "Rookie";
                if (shift < 60) return "Experienced";
                if (shift < 120) return "Specialist";
                if (shift < 200) return "Veteran";
                return "Master Officer";
            }
            
            getUniquenessStats(generatedCount) {
                const percentExplored = ((generatedCount / this.totalPossible) * 100).toFixed(6);
                const repeatProbability = (1 - Math.exp(-generatedCount / this.totalPossible)) * 100;
                const estimatedToRepeat = Math.floor(1 / (repeatProbability / 100));
                
                return {
                    totalPossible: this.totalPossible.toLocaleString(),
                    generated: generatedCount,
                    percentExplored,
                    repeatProbability: repeatProbability.toFixed(4),
                    estimatedToRepeat,
                    careerStage: this.getCareerStage(generatedCount)
                };
            }
        }

        class MPPDTrafficGame {
            constructor() {
                this.generator = new ProceduralEncounterGenerator();
                
                this.stats = {
                    trafficSafety: 50,
                    communityTrust: 50,
                    mppdApproval: 50,
                    fatigueLevel: 50
                };
                
                this.metrics = {
                    speedingStops: 0,
                    duiArrests: 0,
                    warningsIssued: 0,
                    scenariosPlayed: 0
                };
                
                this.shift = 1;
                this.history = [];
                this.consequences = [];
                this.playerStyle = { strictness: 0, empathy: 0, professionalism: 0 };
                
                this.init();
            }
            
            init() {
                this.updateUI();
                this.setupEventListeners();
                this.generateNewEncounter();
                this.checkOnlineStatus();
                
                window.addEventListener('online', () => this.updateOnlineStatus(true));
                window.addEventListener('offline', () => this.updateOnlineStatus(false));
                
                // Add CSS for animations
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
                    .pulse { animation: pulse 1s infinite; }
                `;
                document.head.appendChild(style);
            }
            
            generateNewEncounter() {
                const encounter = this.generator.generateEncounter(this.stats, this.shift);
                this.currentEncounter = encounter;
                
                // Update UI
                document.getElementById('character-img').textContent = encounter.image;
                document.getElementById('character-name').textContent = encounter.name;
                document.getElementById('character-desc').textContent = encounter.description;
                document.getElementById('left-title').textContent = encounter.leftChoice.text;
                document.getElementById('right-title').textContent = encounter.rightChoice.text;
                document.getElementById('location').textContent = encounter.location;
                document.getElementById('current-focus').textContent = encounter.focus;
                document.getElementById('career-stage').textContent = this.generator.getCareerStage(this.shift);
                
                // Update flavor text
                const leftFlavors = ["Strict protocol", "By the book", "Full enforcement", "Zero tolerance"];
                const rightFlavors = ["Use discretion", "Consider context", "Educational approach", "Community focus"];
                document.getElementById('left-text').textContent = this.generator.randomWeighted(leftFlavors);
                document.getElementById('right-text').textContent = this.generator.randomWeighted(rightFlavors);
                
                // Update uniqueness stats
                this.updateUniquenessDisplay();
            }
            
            makeChoice(choice) {
                const card = choice === 'left' ? document.querySelector('.left-card') : document.querySelector('.right-card');
                card.classList.add(choice === 'left' ? 'card-swipe-left' : 'card-swipe-right');
                
                setTimeout(() => {
                    const chosen = choice === 'left' ? this.currentEncounter.leftChoice : this.currentEncounter.rightChoice;
                    
                    // Apply effects
                    this.applyEffects(chosen.effect);
                    
                    // Update metrics
                    this.updateMetrics(chosen);
                    
                    // Add to dispatch log
                    this.addToDispatchLog(chosen.dispatch);
                    
                    // Update 10-code
                    document.getElementById('ten-code').textContent = chosen.tenCode;
                    
                    // Record history
                    this.history.push({
                        shift: this.shift,
                        encounter: this.currentEncounter.name,
                        choice: chosen.text,
                        effects: chosen.effect
                    });
                    
                    // Update player style analysis
                    this.analyzePlayerStyle(choice, chosen);
                    
                    // Increment shift and generate new encounter
                    this.shift++;
                    this.metrics.scenariosPlayed++;
                    this.generateNewEncounter();
                    this.updateUI();
                    
                    // Check for consequences from previous decisions
                    this.checkConsequences();
                    
                    // Remove animation
                    card.classList.remove('card-swipe-left', 'card-swipe-right');
                    
                    // Check game over
                    this.checkGameOver();
                    
                }, 500);
            }
            
            applyEffects(effects) {
                Object.keys(effects).forEach(stat => {
                    this.stats[stat] = Math.max(0, Math.min(100, this.stats[stat] + effects[stat]));
                });
            }
            
            updateMetrics(choice) {
                if (choice.tenCode === "10-50") {
                    // Citation issued
                    const violation = this.currentEncounter.metadata.violation.code;
                    if (violation === "SPEED") this.metrics.speedingStops++;
                    if (violation === "DUI") this.metrics.duiArrests++;
                } else {
                    // Warning issued
                    this.metrics.warningsIssued++;
                }
                
                this.updateMetricsDisplay();
            }
            
            updateMetricsDisplay() {
                document.getElementById('speeding-stops').textContent = this.metrics.speedingStops;
                document.getElementById('dui-arrests').textContent = this.metrics.duiArrests;
                document.getElementById('warnings-issued').textContent = this.metrics.warningsIssued;
                document.getElementById('scenarios-played').textContent = this.metrics.scenariosPlayed;
            }
            
            addToDispatchLog(entry) {
                const log = document.getElementById('dispatch-log');
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = entry;
                log.insertBefore(logEntry, log.firstChild);
                
                // Keep only last 6 entries
                while (log.children.length > 6) {
                    log.removeChild(log.lastChild);
                }
            }
            
            analyzePlayerStyle(choice, chosen) {
                // Track player's enforcement style
                if (choice === 'left') {
                    this.playerStyle.strictness += 1;
                } else {
                    this.playerStyle.empathy += 1;
                }
                
                // Professionalism based on balanced decisions
                if (Math.abs(chosen.effect.trafficSafety) > 15 || Math.abs(chosen.effect.communityTrust) > 15) {
                    this.playerStyle.professionalism += 0.5;
                } else {
                    this.playerStyle.professionalism += 1;
                }
            }
            
            checkConsequences() {
                // Every 10 shifts, check for consequences from previous decisions
                if (this.shift % 10 === 0 && this.history.length > 5) {
                    const recentStrict = this.history.slice(-5).filter(h => h.choice.includes('citation')).length;
                    const recentLenient = this.history.slice(-5).filter(h => h.choice.includes('Warning')).length;
                    
                    if (recentStrict >= 4) {
                        this.consequences.push({
                            shift: this.shift,
                            message: "Multiple citizens have filed complaints about your strict enforcement style.",
                            effect: { communityTrust: -10, mppdApproval: 5 }
                        });
                    } else if (recentLenient >= 4) {
                        this.consequences.push({
                            shift: this.shift,
                            message: "Command staff notes your lenient approach may compromise safety.",
                            effect: { trafficSafety: -10, mppdApproval: -10 }
                        });
                    }
                    
                    // Apply any pending consequences
                    this.applyPendingConsequences();
                }
            }
            
            applyPendingConsequences() {
                this.consequences.forEach(consequence => {
                    if (consequence.shift === this.shift) {
                        this.applyEffects(consequence.effect);
                        this.addToDispatchLog(`[ADMIN] ${consequence.message}`);
                        this.consequences = this.consequences.filter(c => c.shift !== this.shift);
                    }
                });
            }
            
            updateUI() {
                // Update stats with color coding
                Object.keys(this.stats).forEach(stat => {
                    const element = document.getElementById(stat);
                    if (element) {
                        const span = element.querySelector('span');
                        if (span) {
                            span.textContent = this.stats[stat];
                            
                            // Color coding
                            if (this.stats[stat] < 25) {
                                span.style.color = '#F44336';
                            } else if (this.stats[stat] < 50) {
                                span.style.color = '#FF9800';
                            } else if (this.stats[stat] < 75) {
                                span.style.color = '#4CAF50';
                            } else {
                                span.style.color = '#FFD700';
                            }
                        }
                    }
                });
                
                // Update shift counter
                document.getElementById('shift').textContent = this.shift;
                
                // Fatigue warning animation
                const fatigueElement = document.getElementById('fatigue-level');
                if (this.stats.fatigueLevel >= 80) {
                    fatigueElement.classList.add('pulse');
                } else {
                    fatigueElement.classList.remove('pulse');
                }
            }
            
            updateUniquenessDisplay() {
                const stats = this.generator.getUniquenessStats(this.metrics.scenariosPlayed);
                const dispatchLog = document.getElementById('dispatch-log');
                const statsEntry = dispatchLog.querySelector('.log-entry:last-child');
                
                if (!statsEntry || !statsEntry.textContent.includes('Uniqueness:')) {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    entry.textContent = `[SYSTEM] Uniqueness: ${stats.percentExplored}% of 7.1M scenarios explored`;
                    dispatchLog.appendChild(entry);
                }
            }
            
            checkGameOver() {
                let gameOver = false;
                let message = "";
                
                if (this.stats.trafficSafety <= 0) {
                    gameOver = true;
                    message = "Target Zero FAILED. Traffic fatalities increased. You were reassigned to desk duty.";
                } else if (this.stats.trafficSafety >= 100) {
                    gameOver = true;
                    message = "OUTSTANDING! Zero fatalities achieved. Promotion to Traffic Sergeant!";
                } else if (this.stats.communityTrust <= 0) {
                    gameOver = true;
                    message = "Community trust destroyed. Multiple lawsuits pending. Early retirement forced.";
                } else if (this.stats.communityTrust >= 100) {
                    gameOver = true;
                    message = "Community Hero Award! Citizens trust MPPD completely. Chief's commendation.";
                } else if (this.stats.mppdApproval <= 0) {
                    gameOver = true;
                    message = "Command staff lost confidence. Transferred to records division.";
                } else if (this.stats.mppdApproval >= 100) {
                    gameOver = true;
                    message = "Command recognition! Assigned to lead Target Zero statewide initiative.";
                } else if (this.stats.fatigueLevel >= 100) {
                    gameOver = true;
                    message = "Critical error due to exhaustion. Mandatory medical leave. Career jeopardized.";
                }
                
                if (gameOver) {
                    setTimeout(() => {
                        if (confirm(`END OF SHIFT REPORT\n\n${message}\n\nFinal Stats:\n‚Ä¢ Scenarios: ${this.metrics.scenariosPlayed}\n‚Ä¢ Career Stage: ${this.generator.getCareerStage(this.shift)}\n‚Ä¢ Style: ${this.getPlayerStyle()}\n\nStart new career?`)) {
                            this.resetGame();
                        }
                    }, 1000);
                }
            }
            
            getPlayerStyle() {
                const total = this.playerStyle.strictness + this.playerStyle.empathy;
                if (total === 0) return "Balanced";
                
                const strictRatio = this.playerStyle.strictness / total;
                if (strictRatio > 0.7) return "Strict Enforcer";
                if (strictRatio < 0.3) return "Community Officer";
                return "Balanced Professional";
            }
            
            resetGame() {
                this.stats = { trafficSafety: 50, communityTrust: 50, mppdApproval: 50, fatigueLevel: 50 };
                this.metrics = { speedingStops: 0, duiArrests: 0, warningsIssued: 0, scenariosPlayed: 0 };
                this.shift = 1;
                this.history = [];
                this.consequences = [];
                this.playerStyle = { strictness: 0, empathy: 0, professionalism: 0 };
                
                this.updateUI();
                this.updateMetricsDisplay();
                this.generateNewEncounter();
                
                const dispatchLog = document.getElementById('dispatch-log');
                dispatchLog.innerHTML = `
                    <div class="log-entry">[07:00] 10-41, beginning new career</div>
                    <div class="log-entry">[07:00] Procedural system: 7,188,480 scenarios available</div>
                `;
                
                document.getElementById('ten-code').textContent = "10-41";
            }
            
            setupEventListeners() {
                document.getElementById('left-card').addEventListener('click', () => this.makeChoice('left'));
                document.getElementById('right-card').addEventListener('click', () => this.makeChoice('right'));
                
                // Touch swipe support
                let touchStartX = 0;
                document.addEventListener('touchstart', e => {
                    touchStartX = e.changedTouches[0].screenX;
                });
                
                document.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const diff = touchStartX - touchEndX;
                    
                    if (Math.abs(diff) > 50) {
                        if (diff > 0) this.makeChoice('right');
                        else this.makeChoice('left');
                    }
                });
                
                // Keyboard support
                document.addEventListener('keydown', e => {
                    if (e.key === 'ArrowLeft') this.makeChoice('left');
                    if (e.key === 'ArrowRight') this.makeChoice('right');
                    if (e.key === 'r' || e.key === 'R') this.resetGame();
                });
            }
            
            checkOnlineStatus() {
                this.updateOnlineStatus(navigator.onLine);
            }
            
            updateOnlineStatus(online) {
                const statusElement = document.getElementById('offline-status');
                if (online) {
                    statusElement.textContent = '‚óè MPCOM Online';
                    statusElement.className = 'offline-status online';
                } else {
                    statusElement.textContent = '‚óè MPCOM Offline';
                    statusElement.className = 'offline-status offline';
                }
            }
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new MPPDTrafficGame();
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
            
            // Prevent accidental refresh
            window.addEventListener('beforeunload', (e) => {
                if (window.game.shift > 10) {
                    e.preventDefault();
                    e.returnValue = 'Your patrol progress will be lost. Are you sure?';
                }
            });
        });
    </script>
</body>
</html>
